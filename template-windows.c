#include "gen-make.h"

const char *make_template[] = {
  "#",
  "# GNU Makefile for project X (MSVC+clang-cl).",
  "# Generated by 'gen-make' at %T.",
  "#",
  "THIS_FILE := $(firstword $(MAKEFILE_LIST))",
  "TODAY     := $(shell date +%d-%B-%Y)",
  "PYTHON    := py -3",
  "MAKEFLAGS += --warn-undefined-variables",
  "",
  "VER_MAJOR = 1  #! Change this",
  "VER_MINOR = 2  #! Change this",
  "VER_PATCH = 3  #! Change this",
  "VERSION   = $(VER_MAJOR).$(VER_MINOR).$(VER_PATCH)",
  "",
  "%v",
  "",
  "#",
  "# Options:",
  "#",
  "USE_ASTYLE    ?= %a",
  "USE_OPENSSL   ?= 0",
  "USE_CRT_DEBUG ?= 0",
  "",
  "#",
  "# What to build:",
  "#",
  "TARGETS = bin/foo.exe   #! Change this",
  "",
  "#",
  "# Location of required packages",
  "#",
  "OPENSSL_ROOT = c:/dev/src/inet/Crypto/OpenSSL  #! Example requirement.",
  "MSVC_ROOT    = $(realpath $(VSINSTALLDIR))",
  "",
  "define Usage",
  "",
  "  Usage: $(MAKE) -f $(THIS_FILE) CC=[cl | clang-cl] [all | depend | clean | vclean | install]",
  "endef",
  "",
  "ifneq ($(CC),cl)",
  "  ifneq ($(CC),clang-cl)",
  "    $(error $(Usage))",
  "  endif",
  "endif",
  "",
  "OBJ_DIR = objects",
  "",
  "#",
  "# Undefine any '%CL%' env-var",
  "#",
  "export CL=",
  "",
  "#",
  "# Since 'clang-cl' could pick up some .h-files from this.",
  "# Just remove it.",
  "#",
  "export C_INCLUDE_PATH=",
  "",
  "c_to_obj   = $(addprefix $(OBJ_DIR)/, $(notdir $(1:.c=.obj)))",
  "cc_to_obj  = $(addprefix $(OBJ_DIR)/, $(notdir $(1:.cc=.obj)))",
  "cpp_to_obj = $(addprefix $(OBJ_DIR)/, $(notdir $(1:.cpp=.obj)))",
  "",
  "INSTALL_ROOT = $(VC_ROOT)",
  "",
  "CFLAGS = -nologo -W3 -Zi -O2 -I.     \\",
  "         -I./$(OBJ_DIR)              \\",
  "         -D_CRT_NONSTDC_NO_WARNINGS  \\",
  "         -D_CRT_OBSOLETE_NO_WARNINGS \\",
  "         -D_CRT_SECURE_NO_DEPRECATE  \\",
  "         -D_CRT_SECURE_NO_WARNINGS",
  "",
  "CFLAGS += -D_WIN32_WINNT=0x0601 -DHAVE_CONFIG_H -I. #! Add include dirs as needed",
  "",
  "LDFLAGS = -nologo -debug -incremental:no -map -verbose",
  "RCFLAGS = -nologo",
  "",
  "ifeq ($(CC),clang-cl)",
  "  CFLAGS  += -fms-compatibility \\",
  "             -ferror-limit=5",
  "  RCFLAGS += -D__clang__",
  "else",
  "  RCFLAGS += -D_MSC_VER",
  "endif",
  "",
  "ifeq ($(USE_CRT_DEBUG),1)",
  "  CFLAGS  += -MDd -GF -GS -RTCs -RTCu -RTCc",
  "  RCFLAGS += -D_DEBUG",
  "else",
  "  CFLAGS += -MD",
  "endif",
  "",
  "CXXFLAGS = -std:c++17 -TP -EHsc  #! CFLAGS for C++",
  "",
  "EX_LIBS += ws2_32.lib  #! Add more libs as needed",
  "",
  "ifeq ($(USE_OPENSSL),1)",
  "  CFLAGS  += -DHAVE_OPENSSL -DOPENSSL_USE_DEPRECATED -I$(OPENSSL_ROOT)/include",
  "  EX_LIBS += $(OPENSSL_ROOT)/lib/libssl.lib $(OPENSSL_ROOT)/lib/libcrypto.lib",
  "endif",
  "",
  "SOURCES = %s",
  "",
  "OBJECTS = $(call c_to_obj, $(SOURCES))",
  "",
  "GENERATED = $(OBJ_DIR)/config.h",
  "",
  "all: $(GENERATED) $(TARGETS)",
  "\t$(call green_msg, Welcome to 'TARGETS' (CC=$(CC)).)",
  "",
  "$(OBJ_DIR) bin lib:",
  "\tmkdir --parents $(OBJ_DIR)",
  "",
  "bin/foo.exe: $(OBJECTS) | bin #! maybe add a '$(OBJ_DIR)/foo.res' here?",
  "\t$(call link_EXE, $@, $^ $(EX_LIBS))",
  "",
  "#",
  "#! Unless the '$(OBJECTS)' exports something, this could create no 'lib/foo_imp.lib' file.",
  "#",
  "lib/foo_imp.lib: bin/foo.dll",
  "bin/foo.dll: $(OBJECTS) | bin lib",
  "\t$(call link_DLL, $@, $^ $(EX_LIBS), lib/foo_imp.lib)",
  "%c",
  "#",
  "# Link $(TARGETS) with this instead?",
  "#",
  "lib/foo.lib: $(LIB_OBJ) | lib",
  "\t$(call create_static_lib, $@, $(LIB_OBJ))",
  "",
  "$(OBJ_DIR)/%.res: %.rc | $(OBJ_DIR)",
  "\t$(call create_res_file, $@, $<)",
  "",
  "$(OBJ_DIR)/config.h: $(THIS_FILE) | $(OBJ_DIR)",
  "\t$(call generate, $@,//)",
  "\t$(file >> $@,$(CONFIG_H))",
  "",
  "$(OBJ_DIR)/foo.rc: $(THIS_FILE) | $(OBJ_DIR)",
  "\t$(call generate, $@,//)",
  "\t$(file >> $@,$(FOO_RC))",
  "",
  "install: $(TARGETS)",
  "\tcp --update $(TARGETS) $(TARGETS:.exe=.pdb) $(INSTALL_ROOT)/bin",
  "\t@echo",
  "",
  "clean:",
  "\trm -f $(GENERATED) link.tmp",
  "\trm -fr $(OBJ_DIR)",
  "",
  "vclean realclean: clean",
  "\trm -f .depend.Windows",
  "\trm -fr bin lib",
  "",
  "%.i: %.c $(OBJ_DIR)/cpp-filter.py $(GENERATED) FORCE",
  "\t$(call C_preprocess, $@, $<)",
  "",
  "FORCE:",
  "",
  "$(OBJ_DIR)/cpp-filter.py: $(THIS_FILE) | $(OBJ_DIR)",
  "\t$(call generate, $@, #)",
  "\t$(file >> $@,if 1:)",
  "\t$(file >> $@,$(cpp_filter_PY))",
  "",
  "#",
  "# GNU-make macros:",
  "#",
  "# This assumes you have CygWin/Msys's 'echo' with colour support.",
  "#",
  "BRIGHT_GREEN = \\e[1;32m",
  "BRIGHT_WHITE = \\e[1;37m",
  "",
  "colour_msg = @echo -e \"$(1)\\e[0m\"",
  "green_msg  = $(call colour_msg,$(BRIGHT_GREEN)$(strip $(1)))",
  "",
  "define generate",
  "  $(call green_msg, Generating $(1))",
  "  $(file > $(1),$(call Warning,$(2)))",
  "endef",
  "",
  "define Warning",
  "  $(1)",
  "  $(1) DO NOT EDIT! This file was automatically generated",
  "  $(1) from $(realpath $(THIS_FILE)) at $(TODAY). Edit that file instead.",
  "  $(1)",
  "endef",
  "",
  "define create_resp_file",
  "  $(file > $(1))",
  "  $(foreach f, $(2), $(file >> $(1),$(strip $(f))) )",
  "endef",
  "",
  "define C_compile",
  "  $(CC) -c $(CFLAGS) -Fo./$(strip $(1) $(2))",
  "  @echo",
  "endef",
  "",
  "define link_EXE",
  "  $(call green_msg, Linking $(1))",
  "  link $(LDFLAGS) -out:$(strip $(1)) $(2) > link.tmp",
  "  @cat link.tmp >> $(1:.exe=.map)",
  "  @echo",
  "endef",
  "",
  "define link_DLL",
  "  $(call green_msg, Linking $(1))",
  "  link $(LDFLAGS) -dll -out:$(strip $(1)) -implib:$(strip $(3)) $(2) > link.tmp",
  "  @cat link.tmp >> $(1:.dll=.map)",
  "  @rm -f $(3:.lib=.exp)",
  "  @echo",
  "endef",
  "",
  "define create_static_lib",
  "  $(call green_msg, Creating static library $(1))",
  "  rm -f $(1)",
  "  lib -nologo -out:$(strip $(1)) -machine:$(CPU) $(2)",
  "  @echo",
  "endef",
  "",
  "define create_res_file",
  "  $(call green_msg, Creating $(1))",
  "  rc $(RCFLAGS) -Fo./$(strip $(1)) $(2)",
  "  @echo",
  "endef",
  "",
  "#",
  "# clang-cl: /d1PP  Retain macro definitions in /E mode",
  "#",
  "ifeq ($(CC),clang-cl)",
  "  d1PP = -d1PP",
  "else",
  "  d1PP =",
  "endif",
  "",
  "ifeq ($(USE_ASTYLE),1)",
  "  pp_filter  = | astyle",
  "  pp_comment = The preprocessed and Astyled output of $(strip $(1))",
  "else",
  "  pp_filter  =",
  "  pp_comment = The raw preprocessed output of $(strip $(1))",
  "endif",
  "",
  "define C_preprocess",
  "  $(file  > $(1), /* $(call pp_comment, $(2)) */)",
  "  $(file >> $(1),  * $(CC) -E)",
  "  $(foreach f, $(CFLAGS), $(file >> $(1),  *   $(f)))",
  "  $(file >> $(1), ---------------------------------)",
  "  $(file >> $(1),  */)",
  "  $(CC) -E $(CFLAGS) $(d1PP) $(2) | $(PYTHON) $(OBJ_DIR)/cpp-filter.py $(pp_filter) >> $(1)",
  "endef",
  "",
  "define CONFIG_H",
  "  #pragma once",
  "  #define WIN32_LEAN_AND_MEAN",
  "",
  "  #ifndef _CRT_NONSTDC_NO_WARNINGS",
  "  #define _CRT_NONSTDC_NO_WARNINGS",
  "  #endif",
  "  #ifndef _CRT_OBSOLETE_NO_WARNINGS",
  "  #define _CRT_OBSOLETE_NO_WARNINGS",
  "  #endif",
  "  #ifndef _CRT_SECURE_NO_DEPRECATE",
  "  #define _CRT_SECURE_NO_DEPRECATE",
  "  #endif",
  "  #ifndef _CRT_SECURE_NO_WARNINGS",
  "  #define _CRT_SECURE_NO_WARNINGS",
  "  #endif",
  "  /* !Add more stuff here... */",
  "endef",
  "",
  "define FOO_RC",
  "  #include <winver.h>",
  "",
  "  #if defined(__clang__)",
  "    #define RC_HOST        \"clang\"",
  "  #elif defined(_MSC_VER)",
  "    #define RC_HOST        \"MSVC\"",
  "  #else",
  "    #error \"Unsupported compiler\"",
  "  #endif",
  "",
  "  #define RC_VERSION    $(VER_MAJOR),$(VER_MINOR),$(VER_PATCH),0",
  "",
  "  #ifdef _DEBUG",
  "    #define RC_FILEFLAGS 1",
  "    #define RC_DBG_REL   \", debug\"",
  "  #else",
  "    #define RC_FILEFLAGS 0",
  "    #define RC_DBG_REL   \", release\"",
  "  #endif",
  "",
  "  LANGUAGE  0x09,0x01",
  "",
  "  VS_VERSION_INFO VERSIONINFO",
  "    FILEVERSION    RC_VERSION",
  "    PRODUCTVERSION RC_VERSION",
  "    FILEFLAGSMASK  0x3FL",
  "    FILEOS         VOS__WINDOWS32",
  "    FILETYPE       VFT_APP",
  "    FILESUBTYPE    0x0L",
  "    FILEFLAGS      RC_FILEFLAGS",
  "",
  "  BEGIN",
  "    BLOCK \"StringFileInfo\"",
  "    BEGIN",
  "      BLOCK \"040904B0\"",
  "      BEGIN",
  "        VALUE \"CompanyName\",     \"http://www.foo.com/\"",
  "        VALUE \"FileDescription\", \"foo-bar (\" RC_HOST RC_DBG_REL \").\"",
  "        VALUE \"FileVersion\",     \"$(VERSION).\"",
  "        VALUE \"InternalName\",    \"foo-bar.\"",
  "        VALUE \"LegalCopyright\",  \"GNU GENERAL PUBLIC LICENSE v2 or comercial licence.\"",
  "        VALUE \"Comments\",        \"Built on $(TODAY) by ...\"",
  "      END",
  "    END",
  "",
  "    BLOCK \"VarFileInfo\"",
  "    BEGIN",
  "      VALUE \"Translation\", 0x409, 1200",
  "    END",
  "  END",
  "endef",
  "",
  "define cpp_filter_PY",
  "  import sys, os",
  "",
  "  empty_lines = 0",
  "  while True:",
  "    line = sys.stdin.readline()",
  "    if not line:",
  "       break",
  "    line = line.rstrip()",
  "    if line == '':",
  "       empty_lines += 1",
  "       continue",
  "",
  "    #",
  "    # MSVC or clang-cl 'line' directive",
  "    #",
  "    if line.startswith('#line') or line.startswith('# '):",
  "       line = line.replace (r'\\\\', '/')",
  "",
  "    print (line)",
  "",
  "    #",
  "    # Print a newline after a functions or structs",
  "    #",
  "    if line == '}' or line == '};':",
  "       print ('')",
  "",
  "  print ('Removed %d empty lines.' % empty_lines, file=sys.stderr)",
  "endef",
  "",
  "DEP_CFLAGS  = -MM $(filter -I% -D%, $(CFLAGS))",
  "DEP_REPLACE = sed -e 's/\\(.*\\)\\.o: /\\n$$(OBJ_DIR)\\/\\1.obj: /'",
  "",
  "depend: $(GENERATED)",
  "\tgcc $(DEP_CFLAGS) $(SOURCES) | $(DEP_REPLACE) > .depend.Windows",
  "",
  "-include .depend.Windows",
  NULL
};

const char *c_rule   = "$(OBJ_DIR)/%.obj: %.c | $(OBJ_DIR)\n\t$(call C_compile, $@, $<)\n";
const char *cc_rule  = "$(OBJ_DIR)/%.obj: %.cc | $(OBJ_DIR)\n\t$(call C_compile, $@, $(CXXFLAGS) $<)\n";
const char *cpp_rule = "$(OBJ_DIR)/%.obj: %.cpp | $(OBJ_DIR)\n\t$(call C_compile, $@, $(CXXFLAGS) $<)\n";
const char *cxx_rule = "$(OBJ_DIR)/%.obj: %.cxx | $(OBJ_DIR)\n\t$(call C_compile, $@, $(CXXFLAGS) $<)\n";

